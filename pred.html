<!doctype html>
<html>
<head>
<meta charset="UTF8">
<title>Social Data & Visualization - Final Project</title>
<link rel="stylesheet" href="styles.css" type="text/css" />
<link rel="stylesheet" href="svg-styles.css?version=22" type="text/css" />
<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script type="text/javascript" src="d3/d3.js"></script>
<script type="text/javascript" src="d3/index.js"></script>
<script src="colorbrewer.min.js"></script>
<!--[if lt IE 9]>
<script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->
<!--
anatine, a free CSS web template by ZyPOP (zypopwebtemplates.com/)

Download: http://zypopwebtemplates.com/

License: Creative Commons Attribution
//-->
<meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0" />
</head>

<body>
<section id="body" class="width">
		<aside id="sidebar" class="column-left">
			<header>
				<h1><a href="#">Final<br> Project</a></h1>
				<h2>Social Data & Visualization<br>Course 02806 @ DTU </h2>
			</header>
			<nav id="mainnav">
				<ul>
	            	<li><a href="index.html">Home</a></li>
	           		<li><a href="#">About the data</a></li>
	           		<li><a href="pred.html">Predictions</a></li>
	           		<li><a href="machinelearning.html">Machine Learning</a></li>
	            	<li><a href="#">Ipython notebook</a></li>
	            	<li><a href="#">Contact</a></li>
	            	<li><a href="nationality.html">Nationality</a></li>
	            </ul>
			</nav>
		</aside>		
	<section id="content" class="column-right">  		
	    <article>			
		<h2>Predicting wealthy areas</h2>

			<div class="text-container">
				<p>
					Something clever, corny and catchy here please!
				</p>
			</div>
			<div class="viz-container-2 container"></div>
			<div class="viz-container-1 container"></div>
			<div class="group-viz">
				<div>

					
				</div>
				<div class="slider">
					<p>
				      <label for="amount" class ="slider-label">Year:</label>
				      <input type="text" id="amount" readonly class="slider-input">
				    </p>
					<div id="slider-range-max"></div>
				<div>

			</div>
		
		</article>
		<article>
		<h2>Other title</h2>
			<div class="article-info">Social Data & Visualization 2017</div>
			<div class="text-container">
				<p>
					Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nunc vulputate ante eget imperdiet aliquet. Quisque eget eros lacus. Etiam tempor, libero ut dapibus sagittis, mi sapien aliquet dui, et pretium eros arcu id magna. Vivamus blandit a turpis at sollicitudin. Donec sed mi at justo finibus faucibus eu vulputate quam. Curabitur congue, sapien eget aliquam eleifend, orci risus ullamcorper mauris, eu sagittis est lectus sed dolor. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In tortor odio, commodo eu efficitur nec, dignissim quis dolor.
				</p>
			</div>

			<div class="viz-container"></div>
		</article>
		
		<footer class="clear">
			<p>&copy; 2015 sitename. <a href="http://zypopwebtemplates.com/">Website Template by</a> by ZyPOP</p>
		</footer>
	</section>
	<div class="clear"></div>
</section>

<script type="text/javascript">
WID =  window.innerWidth-300
HID =  window.innerHeight-150
console.log('wid: '+WID)
console.log('hid: '+HID)
var w = WID;
var h = HID;
var W = 486;
var H = 519;
var centered;
//------COLOR ON MAP---------//
var colours = colorbrewer.RdYlGn[11]

var heatmapColour = d3.scale.threshold()
  .domain(d3.range(0, 1, 1.0 / (colours.length - 1)))
  .range(colours);
// dynamic bit...
var c = d3.scale.linear().domain([0,100]).range([0,1]);
//--------------------------//

//---------CREATE BASIS FOR GEOJSON MAP AND BAR------//
var svg = d3.select(".viz-container-1").append("svg")
	.attr("width", W)
    .attr("height",H)
    .attr("id",'chart1')

svg.append("rect")
    .attr("class", "background")
    .attr("width", W)
    .attr("height", H)
    .on("click", clicked);

var mapG = svg.append("g");

var p = d3.geo.mercator()
			.center([12.5541493,55.673577])
			.scale(135000)

			.translate([W / 2, H / 2]);
var path = d3.geo.path().projection(p);

createMap()

var districtTitle = svg.append("g")
  .attr("class", "title")
  .style("display", "none");
    
districtTitle.append("rect")
  .attr("width", W)
  .attr("height", 60)
  .attr("fill", "white")
  .style("opacity", 0.8);

districtTitle.append("text")
  .attr('x',W/2)
  .attr("dy", "1.2em")
  .style("text-anchor", "middle")
  .attr("font-size", "35px")
  .attr("font-weight", "bold")
  .text('Bagsværds');

//-------------------------------------------//

//------CREATE BASIS FOR BAR---------//
var Wshrink = 350
var barMargin = {top: 40, right: 20, bottom: 10, left: 26};
var barMargin2 = {top: 40, right: 150, bottom: 10, left: 26};
var barW = W-Wshrink - barMargin.left - barMargin.right,
    barH = H - barMargin.top - barMargin.bottom;

var barW2 = W - (Wshrink - (barMargin2.right-barMargin.right))- barMargin2.left - barMargin2.right,
    barH2 = H - barMargin2.top - barMargin2.bottom;

var barG = d3.select(".viz-container-1").append("svg")
 	.attr("width", barW +  barMargin.left + barMargin.right)
    .attr("height", barH  + barMargin.top + barMargin.bottom)
    .append("g")
    .attr("id",'chart2')
    .attr("transform", "translate(" + barMargin.left + "," + barMargin.top + ")")
    .classed("hidden",true);

var barG2 = d3.select(".viz-container-1").append("svg")
 	.attr("width", barW2 +  barMargin2.left + barMargin2.right)
    .attr("height", barH2  + barMargin2.top + barMargin2.bottom)
    .append("g")
    .attr("id",'chart2')
    .attr("transform", "translate(" + barMargin2.left + "," + barMargin2.top + ")")
    .classed("hidden",false);


/***********-----DUMMY DATA FOR TEST*************/

var data0=[{low: "0", med: "0", high: "0"}];
var dataAge0= [{"a0_5":"0", "a6_17":"0", "a18_29":"0", "a30_39":"0", "a40_49":"0", "a50_65":"0", "a65":"0"}];			

var dataset0 = d3.layout.stack()(["low", "med", "high"].map(function(income) {
  return data0.map(function(d) {
    return {x: 'Income', y: +d[income]};
  });
}));

var datasetAge0 = d3.layout.stack()(["a0_5", "a6_17", "a18_29", "a30_39", "a40_49", "a50_65", "a65"].map(function(age) {
  return dataAge0.map(function(d) {
    return {x: 'Age', y: +d[age]};
  });
})); 
// Set x, y and colors
// 
var xStackScale = d3.scale.ordinal()
  .domain(['Income distribution'])
  .rangeRoundBands([10, barW-10], 0.10);

var xStackScaleAge = d3.scale.ordinal()
  .domain(['Age distribution'])
  .rangeRoundBands([10, barW2-10], 0.1);

var yStackScale = d3.scale.linear()
  .domain([0, 100])
  .range([barH, 0]);

var barColorsAge = colorbrewer.Oranges[7];
var barColors = colorbrewer.Blues[3]
var allColors = barColorsAge.concat(["#FFFFFF","#FFFFFF"]).concat(barColors).concat(["#FFFFFF"])
console.log(allColors)
// Define and draw axes
var yAxisBar = d3.svg.axis()
	.scale(yStackScale)
	.orient("left")
	.ticks(5)
	.tickSize(-barW, 0, 0)
	.tickFormat( function(d) { return d+'%' } );

var xAxisBar = d3.svg.axis()
	.scale(xStackScale)
	.orient("top");

var xAxisBarAge = d3.svg.axis()
	.scale(xStackScaleAge)
	.orient("top");

barG.append("g")
  .attr("class", "y axis")
  .call(yAxisBar);
barG.append("g")
  .attr("class", "x axis")
  .attr("transform", "translate(0," + -10 + ")")
  .call(xAxisBar);
barG2.append("g")
  .attr("class", "y axis")
  .call(yAxisBar);
barG2.append("g")
  .attr("class", "x axis")
  .attr("transform", "translate(0," + -10 + ")")
  .call(xAxisBarAge);

// Draw legend
var legend = barG2.selectAll(".legend")
  .data(allColors)
  .enter().append("g")
  .attr("class", "legend")
  .attr("transform", function(d, i) {
    typical = "translate(30," + i * 19 + ")"; 
    textType = "translate(7," + i * 19 + ")"; 
    switch (i) {
      case 0: return textType;
      case 1: return typical;
      case 2: return typical
      case 3: return typical;
      case 4: return typical;
      case 5: return textType;
      case 6: return typical;
      case 7: return typical;
      case 8: return typical;
      case 9: return typical;
      case 10: return typical;
      case 11: return typical;
      case 12: return typical;
    }
 });
 
legend.append("rect")
  .attr("x", barW - 18)
  .attr("width", 18)
  .attr("height", 18)
  .style("fill", function(d, i) {return allColors.slice().reverse()[i];});
 
legend.append("text")
  .attr("x", barW + 5)
  .attr("y", 9)
  .attr("dy", ".35em")
  .style("text-anchor", "start")
  .text(function(d, i) { 
    switch (i) {
      case 0: return "Income";
      case 1: return "% of high income";
      case 2: return "% of medium income";
      case 3: return "% of low income";
      case 4: return "";
      case 5: return "Age";
      case 6: return "65+";
      case 7: return "50-65";
      case 8: return "40-49";
      case 9: return "30-39";
      case 10: return "18-29";
      case 11: return "6-17";
      case 12: return "0-5";
    }
  });

barG.classed('hidden',true)

var barGroups = barG.selectAll("g.cost")
  .data(dataset0)
  .enter().append("g")
  .attr("class", "cost")
  .style("fill", function(d, i) { return barColors[i]; });

var barRect = barGroups.selectAll("rect")
  .data(function(d) { return d; })
  .enter()
  .append("rect")
  .attr("x", function(d) { return xStackScale(d.x); })
  .attr("y", function(d) { return yStackScale(d.y0 + d.y); })
  .attr("height", function(d) { return yStackScale(d.y0) - yStackScale(d.y0 + d.y); })
  .attr("width", xStackScale.rangeBand())
  .on("mouseover", function() { tooltip.style("display", null); })
  .on("mouseout", function() { tooltip.style("display", "none"); })
  .on("mousemove", function(d) {
    var xPosition = d3.mouse(this)[0] - 15;
    var yPosition = d3.mouse(this)[1] - 25;
    tooltip.attr("transform", "translate(" + xPosition + "," + yPosition + ")");
    tooltip.select("text").text(d.y+'%');
});

barG2.classed('hidden',true)

var barGroups2 = barG2.selectAll("g.cost")
  .data(datasetAge0)
  .enter().append("g")
  .attr("class", "cost")
  .style("fill", function(d, i) { return barColorsAge[i]; });

var barRect2 = barGroups2.selectAll("rect")
  .data(function(d) { return d; })
  .enter()
  .append("rect")
  .attr("x", function(d) { return xStackScaleAge(d.x); })
  .attr("y", function(d) { return yStackScale(d.y0 + d.y); })
  .attr("height", function(d) { return yStackScale(d.y0) - yStackScale(d.y0 + d.y); })
  .attr("width", xStackScaleAge.rangeBand())
  .on("mouseover", function() { tooltip.style("display", null); })
  .on("mouseout", function() { tooltip.style("display", "none"); })
  .on("mousemove", function(d) {
    var xPosition = d3.mouse(this)[0] - 15;
    var yPosition = d3.mouse(this)[1] - 25;
    tooltip.attr("transform", "translate(" + xPosition + "," + yPosition + ")");
    tooltip.select("text").text(d.y+'%');
});

//
// Prep the tooltip bits, initial display is hidden
var tooltip = barG.append("g")
  .attr("class", "tooltip")
  .style("display", "none");
    
tooltip.append("rect")
  .attr("width", 50)
  .attr("height", 20)
  .attr("fill", "white")
  .style("opacity", 0.5);

tooltip.append("text")
  .attr("x", 25)
  .attr("dy", "1.2em")
  .style("text-anchor", "middle")
  .attr("font-size", "12px")
  .attr("font-weight", "bold");




//-------------------------------------//

//------COLORBAR---------//
var colbarHeight = 15;
var gbarback = svg.append("g")
    .attr("class", "key")
    .attr("transform", "translate("+(W/50)+","+(H-100)+")")

gbarback.append("rect")
  .attr("rx", 6)
  .attr("ry", 6)
  .attr("width", 145)
  .attr("height",90)
  .attr("fill", "white")
  .style("opacity", 0.75);

var gbar = gbarback.append("g")
    .attr("class", "key")
    .attr("transform", "translate("+5+","+20+")")



var x = d3.scale.linear()
    .domain([1, 10])
    .rangeRound([0, 120]);
var color = d3.scale.threshold()
    .domain(d3.range(2, 10))
    .range(colorbrewer.RdYlGn[9]);

gbar.selectAll("rect")
  .data(color.range().map(function(d) {
      d = color.invertExtent(d);
      if (d[0] == null) d[0] = x.domain()[0];
      if (d[1] == null) d[1] = x.domain()[1];
      return d;
    }))
  .enter().append("rect")
    .attr("height", colbarHeight)
    .attr("x", function(d) { return x(d[0]); })
    .attr("width", function(d) { return x(d[1]) - x(d[0]); })
    .attr("fill", function(d) { return color(d[0]); });

gbar.append("text").attr("class", "caption").attr("x", x.range()[0]).attr("y", -3).text("% of high income");
gbar.append("text").attr("class", "smallcap").attr("x", x.range()[0]).attr("y",colbarHeight + 10).text("0%");
gbar.append("text").attr("class", "smallcap").attr("x", x.range()[1]-10).attr("y", colbarHeight + 10).text("100%");
gbar.append("rect").attr("height", colbarHeight).attr("y",colbarHeight + 15)
	.attr("width", 11).attr("fill","#EBEDF4").attr("stroke-width",0.2).attr("stroke","#626262")
gbar.append("text").attr("class", "smallcap").attr("x", x.range()[0]+15).attr("y",colbarHeight+ 26 ).text("No residency");
gbar.append("rect").attr("height", colbarHeight).attr("y",colbarHeight+ 35)
	.attr("width", 11).attr("fill","#9EA0A0").attr("stroke-width",0.2).attr("stroke","#626262")
gbar.append("text").attr("class", "smallcap").attr("x", x.range()[0]+15).attr("y",colbarHeight+ 46).text("Missing data");

//----------------------//


//------TIP---------//
var tip = d3.tip()
	  .attr('class', 'd3-tip')
	  .offset([0,0])
	  .html(function(d) {
      year = d3.select('#amount').property("value")
	  	return 	"<div  class='tiphead' ><strong>"+ d['properties']['rodenavn'] +"</strong></div>" + 
	    		"<div><strong>% of high income:</strong> <span class='tipperCol' >" + d['properties'][year] + "</span></div>";
	  });
svg.call(tip);
//-----------------//

var globalRodeId = 1;

function editBar(rodeId) {
	d3.json("bardata.json", function(error,jsonBar) {

		if (error) throw error;
console.log()
		rode = rodeId;
		year = d3.select('#amount').property("value")
		
		var rawData = [jsonBar[rode][year]];
		var datasetIncomeBar = d3.layout.stack()(["low", "med", "high"].map(function(income) {
		  return rawData.map(function(d) {
		    return {y: +d[income]};
		  });
		}));
		

		var datasetAgeBar = d3.layout.stack()(["a0_5","a6_17","a18_29","a30_39","a40_49","a50_64","a65"].map(function(age) {
		  return rawData.map(function(d) {
        if (d[age] >= 0) {
          return {y: +d[age]};//If value exists…
        } else {
          return {y: 0};
        }		    
		  });
		}));

		barGroups.data(datasetIncomeBar);
		barRect.data(function(d) { 
			return d; })
		  .transition()
		  .duration(800)
		  .attr("x", function(d) { return xStackScale(d.x); })
		  .attr("y", function(d) { return yStackScale(d.y0 + d.y); })
		  .attr("height", function(d) { return yStackScale(d.y0) - yStackScale(d.y0 + d.y); })
		  .attr("width", xStackScale.rangeBand());

		barGroups2.data(datasetAgeBar);			
		barRect2.data(function(d) { 
			return d; })
		  .transition()
		  .duration(800)
		  .attr("x", function(d) { return xStackScaleAge(d.x); })
		  .attr("y", function(d) { return yStackScale(d.y0 + d.y); })
		  .attr("height", function(d) { return yStackScale(d.y0) - yStackScale(d.y0 + d.y); })
		  .attr("width", xStackScaleAge.rangeBand());
		
	});
}

function clicked(d,rodeId) {
  var x, y, k;
console.log('yeeee')
console.log(d)
  if (d && centered !== d) {
    var centroid = path.centroid(d);
    x = centroid[0];
    y = centroid[1];
    k = 4;
    centered = d;
    districtTitle.style("display", null)
    districtTitle.select("text").text(d.properties.rodenavn)
    barG.classed('hidden',false)
    barG2.classed('hidden',false)
    editBar(rodeId)
  } else {
    x = W / 2;
    y = H / 2;
    k = 1;
    centered = null;
    districtTitle.style("display", "none")
    barG.classed('hidden',true)
    barG2.classed('hidden',true)
  }

  mapG.selectAll("path")
      .classed("active", centered && function(d) { return d === centered; });

  mapG.transition()
      .duration(750)
      .attr("transform", "translate(" + W / 2 + "," + H / 2 + ")scale(" + k + ")translate(" + -x + "," + -y + ")")
      .style("stroke-width", 1.5 / k + "px");
}

function createMap() {
	d3.json("geodata1.geojson", function(error,json) {
    if (error) throw error;
    mapG.append("g")
      .selectAll("path")
      .data(json.features)
      .enter()
      .append("path")
      .attr("d", path)
      .on('mouseover', tip.show)
      .on('mouseout', tip.hide)
      .on("click", function(d,i){
     		rodeId = d3.select(this).attr("id")
     		globalRodeId = rodeId;
            // editBar(rodeId);
            clicked(d,rodeId)
         })
     .attr('class','map-district')
     .attr('id', function(d){
     		return d.properties.rode_nr
     })
     .style("fill", function(d) {
     		//Get data value
     		var value = d['properties']['2008']
     		
     		if (value > 0) {
  	   		return heatmapColour(c(value));//If value exists…
     		} else if (value == 0) {
  	   		return "#EBEDF4";//If value is undefined…
  	    } else {
  	    	return "#9EA0A0";
     		}
     });

    mapG.append("g")
        .selectAll("path")
        .data(json.features)
        .enter()
        .append("path")
        .attr("id", "district-borders")
        .attr("d", path);
	});
}

function editMap(map,year) {
	
 	mapG.selectAll("path")
        .transition()
        .duration(500)
        .style("fill", function(d) { 
	   		//Get data value
	   		var value = d['properties'][year]

	   		if (value > 0) {
		   		return heatmapColour(c(value));//If value exists…
	   		} else if (value == 0) {
		   		return "#EBEDF4";//If value is undefined…
		    } else {
		    	return "#9EA0A0";
	   		}
	   	});
}
 
$( function() {
	$( "#slider-range-max" ).slider({
	range: "max",
	min: 2008,
	max: 2013,
	value: 2,
	slide: function( event, ui ) {
	    $( "#amount" ).val( ui.value );
	    //var placeholder = $("#viz1")
	    //jQuery("svg", placeholder).remove();

	    var datayear = ui.value.toString() 
	    editMap(mapG, datayear);
	    editBar(globalRodeId)
	}
	});
	$( "#amount" ).val( $( "#slider-range-max" ).slider( "value" ) );
} );

</script>

</body>
</html>
