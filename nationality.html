<!doctype html>
<html>
<head>
<meta charset="UTF8">
<title>Social Data & Visualization - Final Project</title>
<link rel="stylesheet" href="styles.css" type="text/css" />
<link rel="stylesheet" href="svg-styles.css?version=14" type="text/css" />
<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script type="text/javascript" src="d3/d3.js"></script>
<script type="text/javascript" src="d3/index.js"></script>
<script src="colorbrewer.min.js"></script>
<!--[if lt IE 9]>
<script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->
<!--
anatine, a free CSS web template by ZyPOP (zypopwebtemplates.com/)

Download: http://zypopwebtemplates.com/

License: Creative Commons Attribution
//-->
<meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0" />
</head>

<body>
<section id="body" class="width">
		<aside id="sidebar" class="column-left">
			<header>
				<h1><a href="#">Final<br> Project</a></h1>
				<h2>Social Data & Visualization<br>Course 02806 @ DTU </h2>
			</header>
			<nav id="mainnav">
				<ul>
	            	<li><a href="index.html">Home</a></li>
	           		<li><a href="aboutdata.html">About the data</a></li>
                <li><a href="nationality.html">Nationality distribution</a></li>
	           		<li><a href="pred.html">Interactive map</a></li>
	           		<li><a href="machinelearning.html">Machine Learning</a></li>
	            	<li><a href="#">Ipython notebook</a></li>
	            	<li><a href="#">Contact</a></li>
	            </ul>
			</nav>
		</aside>		
	<section id="content" class="column-right">  		
	    <article>			
		<h2>Nationality in Copenhagen over the years</h2>

			<div class="text-container">
				<p>
					Something clever, corny and catchy here please!
				</p>
			</div>
				<div class="slider" style="width:700px">
					<p>
				      <label for="amount" class ="slider-label hidden">Year:</label>
				      <input type="text" id="amount" readonly class="slider-input hidden">
				    </p>
					<div id="slider-range-max"></div>
				<div>

				<div class="viz-container-bars"></div>
				<div>
				<select class="Country select-style"></select>
				<select id="Data" class="select-style">
					<option value=""  selected="selected">Data without districts</option>
			        <option value="1">Data with districts</option>
				</select>
				<select class="District select-style"></select>
				<a href="#" class="button showDanes">See distribution of Danes</a>
				</div>

				<div class="viz-container"></div>
		
		</article>
		<article>
		<h2>Other title</h2>
			<div class="article-info">Social Data & Visualization 2017</div>
			<div class="text-container">
				<p>
					Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nunc vulputate ante eget imperdiet aliquet. Quisque eget eros lacus. Etiam tempor, libero ut dapibus sagittis, mi sapien aliquet dui, et pretium eros arcu id magna. Vivamus blandit a turpis at sollicitudin. Donec sed mi at justo finibus faucibus eu vulputate quam. Curabitur congue, sapien eget aliquam eleifend, orci risus ullamcorper mauris, eu sagittis est lectus sed dolor. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. In tortor odio, commodo eu efficitur nec, dignissim quis dolor.
				</p>
			</div>

			<div class="viz-container"></div>
		</article>
		
		<footer class="clear">
			<p>&copy; 2015 sitename. <a href="http://zypopwebtemplates.com/">Website Template by</a> by ZyPOP</p>
		</footer>
	</section>
	<div class="clear"></div>
</section>




<style> /* set the CSS */

path { 
    stroke: #01665e;
    stroke-width: 3;
    fill: none;
    shape-rendering: auto;
}
.axis path,
.axis line {
    fill: none;
    stroke: grey;
    stroke-width: 1;
    shape-rendering: crispEdges;
}

</style>

<script>
var colours = colorbrewer.BrBG[11]
// Set the dimensions of the canvas / graph
var margin = {top: 50, right: 80, bottom: 80, left: 70},
    width = 700- margin.left - margin.right,
    height = 350 - margin.top - margin.bottom;
    var padding = 3;
// _______________BAR MAKING FKN BARS_________________//
// 
// 
var svgBars = d3.select(".viz-container-bars").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
    	.append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
var xbar = d3.scale.ordinal().rangeRoundBands([0,width], .1)
var ybar = d3.scale.linear().range([height, 0]);
var xAxisBar = d3.svg.axis()
    .scale(xbar)
    .orient("bottom");

var yAxisBar = d3.svg.axis()
    .scale(ybar)
    .orient("left");
    // .tickFormat('%');
  
var tip = d3.tip()
  .attr('class', 'd3-tip')
  .offset([-10, 0])
  .html(function(d) {
    return "<strong>Frequency:</strong> <span style='color:#7CB2C6'>" + Math.round(d.Total) + "</span>";
  });

svgBars.call(tip);

var myTextTitleBar = svgBars.append('text')
		.classed('dataChoose', true)
		.attr("class","nation-title")
		.attr("text-anchor", "left")
		.attr("transform", "translate("+  -10 +","+ -10 +")")
		.text("Top 25 nationalities in CPH in 2015");

d3.csv("KBH_Top25_AllYears.csv",function(error, rawdata) {
	year = 2015 
	
	data = rawdata.filter(function(row) {
	    return row['AAR'] == year;
	});

  xbar.domain(data.map(function(d) {return d.COUNTRY; }));

  ybar.domain([0, d3.max(rawdata.map(function(d) {
  	return +d.Total
  }))]);

  svgBars.append("g")
      .attr("class", "xbar axis")
      .attr("transform", "translate(0," + height + ")")
      .call(xAxisBar)
      .selectAll("text")
	    .attr("y", 0)
	    .attr("x", -9)
	    .attr("dy", ".35em")
	    .attr("transform", "rotate(-90)")
	    .style("text-anchor", "end")

  svgBars.append("g")
      .attr("class", "y axis")
      .call(yAxisBar)
    .append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", -margin.right+20)
      .attr("dy", ".71em")
      .style("text-anchor", "end")
      .text("Frequency");

  svgBars.selectAll(".bar")
      .data(data)
      .enter().append("rect")
      .attr("class", 'bar')
      .attr("id", function(d) { return d.COUNTRY; })
      .style("fill", colours[8])
      .attr("x", function(d) { return xbar(d.COUNTRY); })
      .attr("width", xbar.rangeBand())
      .attr("y", function(d) { return ybar(d.Total); })
      .attr("height", function(d) { return height - ybar(d.Total); })
      .on('mouseover',  function(d,i) {
   		 d3.select(this)
        .style("transform", "scale(1.1,1.1")
        .style("transform-origin", "50% 50%")
        .style("fill", colours[2]);
        tip.show(d)
		})
      .on('mouseout', function(d,i){
      	 d3.select(this)
        .style("transform", "scale(1,1)")
        .style("transform-origin", "50% 50%")
        .style("fill", colours[8]);
        tip.hide(d)
      });
  });
function editBars(year) {
	d3.csv("KBH_Top25_AllYears.csv",function(error, rawdata) {
	    
		
		data = rawdata.filter(function(row) {
		    return row['AAR'] == year;
		});

		xbar.domain(data.map(function(d) {return d.COUNTRY; }));
	  	// ybar.domain([0, d3.max(data, function(d) {return +d.Total; })]);

		svgBars.selectAll(".bar")
			.data(data)
			.transition()
			.duration(800)
			.attr("id", function(d) { return d.COUNTRY; })
			.style("fill", colours[8])
			.attr("x", function(d) { return xbar(d.COUNTRY); })
			.attr("width", xbar.rangeBand())
			.attr("y", function(d) { return ybar(d.Total); })
			.attr("height", function(d) { return height - ybar(d.Total); })

		svgBars.select(".xbar.axis")
		    .transition()
		    .duration(750)
		    .call(xAxisBar)
		    .selectAll("text")
		    .attr("y", 0)
		    .attr("x", -9)
		    .attr("dy", ".35em")
		    .attr("transform", "rotate(-90)")
		    .style("text-anchor", "end");

		svgBars.select(".y.axis") // change the y axis
		    .transition()
		    .duration(750)
		    .call(yAxisBar);	
	});
}


// 
// __________________// __________________// __________//

// Parse the date / time
var parseDate = d3.time.format("%d-%b-%y").parse;

// Adds the svg canvas
var svg = d3.select(".viz-container").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
    	.append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

// Set the ranges
var x = d3.scale.linear().range([padding, width - padding * 2]);
var y = d3.scale.linear().range([height - padding, 0]);
var y1 = d3.scale.linear().range([height - padding, 0]);
// Define the axes
var xAxis = d3.svg.axis().scale(x).orient("bottom").tickFormat(d3.format("y"));

var yAxisLeft = d3.svg.axis().scale(y)
    .orient("left").ticks(5);
var yAxisRight = d3.svg.axis().scale(y1)
    .orient("right").ticks(5); 

var danes = false;

// Define the line
var valueline = d3.svg.line()
    .x(function(d,section) { return x(d.AAR); })
    .y(function(d,section) { return y(d.Total) }); 

var valueline2 = d3.svg.line()
    .x(function(d) { return x(d.AAR); })
    .y(function(d) { 
    	console.log(d)
    	console.log(danes)

    	if (danes) {
			return y1(d.Total)	
    	} else {
    		return y1(d.Percentage)	
    	}

    });

svg.append("text")
.attr("text-anchor", "middle")  // this makes it easy to centre the text as the transform is applied to the anchor
.attr("transform", "translate("+ (width/2) +","+(height+margin.bottom - 15)+")")  // centre below axis
.text("Year");

var ylabel1 = svg.append("text")
.attr("class","ylabel1")
.attr("text-anchor", "middle")  // this makes it easy to centre the text as the transform is applied to the anchor
.attr("transform", "translate("+ (-50) +","+(height/2)+")rotate(-90)")  // text is drawn off the screen top left, move down and out and rotate
.style("fill",colours[10])
.text("Number of citizens from nation");

var ylabel2 = svg.append("text")
.attr("class","ylabel2")
.attr("text-anchor", "middle")  // this makes it easy to centre the text as the transform is applied to the anchor
.attr("transform", "translate("+  (width +50) +","+(height/2) +")rotate(90)")  // text is drawn off the screen top left, move down and out and rotate
.style("fill",colours[2])
.text("Percentage of total foreigners");


var myTextTitle = svg.append('text')
		.classed('dataChoose', true)
		.attr("class","nation-title")
		.attr("text-anchor", "left")
		.attr("transform", "translate("+  -10 +","+ -10 +")");


d3.csv("KBH_Stats_noDanes_noBydel_1.csv", function(error, data) {
 	if (error) throw error;

	selectValueCountry = ""

    data.forEach(function(d) {
        d.AAR = +d.AAR;
        d.STATKODE = +d.STATKODE;
        d.Total = +d.Total;
        d.Percentage = +d.Percentage;
    });

    data = data.filter(function(row) {
        return row['COUNTRY'] == selectValueCountry;
    });

    // Scale the range of the data
    x.domain(d3.extent(data, function(d) 
   	{
   		return d.AAR 
   	}));

    y.domain([0, d3.max(data, function(d) 
    { 
        return Math.max(d.Total);
    })]);

    y1.domain([0, d3.max(data, function(d) 
    { return Math.max(d.Percentage);
    })]);

    svg.append("path")
    .attr("class","line1")
    .attr("d", valueline(data));

    // Add the valueline path.
    danes=false;
    svg.append("path")
    .attr("class", "line2")
    .style("stroke", colours[2])
    .attr("d", valueline2(data));

    // Add the X Axis
    svg.append("g")
    .attr("class", "x axis")
    .attr("transform", "translate(0," + height + ")")
    .call(xAxis);

    // Add the Y Axis
     svg.append("g")
    .attr("class", "yLeft axis")
    .style("fill", colours[10])
    .call(yAxisLeft);

    svg.append("g")             
    .attr("class", "yRight axis")
    .attr("transform", "translate(" + width + " ,0)")     
    .style("fill", colours[2])       
    .call(yAxisRight);

    myTextTitle.data(data).text(function(d) { 
			return d.COUNTRY
		});
});

// Get the data
var dataset = "KBH_Stats_noDanes_noBydel_1.csv"
theCreation(dataset)

function DataSelection() {
    var sect = document.getElementById("Data");
    secVar = sect.options[sect.selectedIndex].value;
    var District = 0
    if (secVar == "1")
    {
        dataset = "KBH_Stats_noDanes.csv"
        District = 1
    }
    else
    {
        dataset = "KBH_Stats_noDanes_noBydel_1.csv"
    }
    theCreation(dataset,District)
}

function theCreation(dataset,District)
{
	d3.csv(dataset, function(error, data) {
	    data.forEach(function(d) {
	        d.AAR = +d.AAR;
	        d.STATKODE = +d.STATKODE;
	        d.Total = +d.Total;
	        d.Percentage = +d.Percentage;
	        if (District == 1)
	        {
	        	d.District =+ d.BYDEL
	        }
	    });
	    // When Country is change!
	    var select = d3.select('.Country')
	        .attr('class','select Country')
	        .on('change',onchange)

	    var options = select
	      .selectAll('option')
	        .data(d3.map(data, function(d){return d['COUNTRY'];}).keys().sort())
	        .enter()
	        .append('option')
	            .text(function (d) { return d});

	    // When District is Change!
	    // if (District == 1)
	    // {
	    	var select = d3.select('.District')
	        .attr('class','select District')
	        .on('change',onchange)
		    var options = select
		      .selectAll('option')
		        .data(d3.map(data, function(d)
		        {
		        	return d['DISTRICT']
		        }).keys().sort())
		        
		        .enter()
		        .append('option')
		            .text(function (d) { return d});
	    // }
	    // else
	    // {

	    // 	var select = d3.select('.District')
	    //     .attr('class','select District')
		   //  var options = select
		   //    .selectAll('option')
		   //    	.remove()
		   //      .append('option')
		   //          .text(function (d) { return 'All Districts'});
	    // }


	    // Dataset is change!
	    d3.select('#Data')
	    	.on('change',DataSelection)

	    function onchange() {
	        selectValueCountry = d3.select('.Country').property('value')
	        selectValueDistrict = d3.select('.District').property('value')
	        plot(data,selectValueCountry,selectValueDistrict)
	    }

      svgBars.selectAll(".bar").on("click", function() {
      		var selectValueCountry = this.id;
      		d3.select('.Country').property('value',this.id)
      		selectValueDistrict = d3.select('.District').property('value')
      		plot(data,selectValueCountry,selectValueDistrict)
        })

	    function plot(data,selectValueCountry){

	        // Filter the data
	        data = data.filter(function(row)
	        {
	        	if (District == 1)
	        	{
	        		return (row['COUNTRY'] == selectValueCountry && row['DISTRICT'] == selectValueDistrict);
	        	}
	        	else
	        	{
		            return row['COUNTRY'] == selectValueCountry;	
	        	}

	        });

	        // Scale the range of the data
	        x.domain(d3.extent(data, function(d) 
	       	{
	       		return d.AAR 
	       	}));

            y.domain([0, d3.max(data, function(d) 
            { 
                return Math.max(d.Total);
            })]);

            y1.domain([0, d3.max(data, function(d) 
            { return Math.max(d.Percentage);
            })]);

            var svg = d3.select("body").transition();

			svg.select(".line1")   // change the line
	        	.duration(750)
	            .attr("d", valueline(data));
	        danes = false;
	        svg.select(".line2")   // change the line
	        	.duration(750)
	            .attr("d", valueline2(data));

	        svg.select(".x.axis") // change the x axis
	            .duration(750)
	            .call(xAxis);
	        svg.select(".yRight.axis") // change the y axis
	            .duration(750)
	            .call(yAxisRight);
	        svg.select(".yLeft.axis") // change the y axis
	            .duration(750)
	            .call(yAxisLeft);

	        myTextTitle.data(data)
			    .transition().duration(1000/2)
			    .style("opacity", 0)
			    .transition().duration(1000/2)
			    .style("opacity", 1)
			    .text(function(d) { return d.COUNTRY });

			ylabel1.transition().duration(1000/2)
			    .style("opacity", 0)
			    .transition().duration(1000/2)
			    .style("opacity", 1)
			    .text('Number of citizens from nation')

			ylabel2.transition().duration(1000/2)
			    .style("opacity", 0)
			    .transition().duration(1000/2)
			    .style("opacity", 1)
			    .text('Percentage of total foreigners')
		}

	});

d3.select(".showDanes").on('mouseover',function(){
	
	plotDanes('Indre By')
});
d3.select(".showDanes").on('mouseout',function(){
	console.log('jazz')
	console.log(dataset)
	theCreation(dataset,0)
});

function plotDanes(selectValueDistrict){
	d3.csv('KBH_Stats.csv', function(error, rawdata) {	
		if (error) throw error;

selectValueCountry = 'Danmark'
selectValueDistrict = "Indre By"
District = 1;
		console.log(selectValueDistrict)
		console.log(data)
        // Filter the data
	        data = rawdata.filter(function(row)
	        {
	        	return (row['COUNTRY'] == 'Danmark' && row['DISTRICT'] == selectValueDistrict);
	        });
	     	data2 = rawdata.filter(function(row)
	        {
	        	return (row['COUNTRY'] == 'Foreign Nations' && row['DISTRICT'] == selectValueDistrict);
	        });

        console.log(data2)

        // Scale the range of the data
        x.domain(d3.extent(data, function(d) 
       	{
       		return d.AAR 
       	}));

        y.domain([30000, d3.max(data, function(d) 
        { 
            return Math.max(d.Total);
        })]);

        y1.domain([30000, d3.max(data2, function(d) 
        { return Math.max(d.Total);
        })]);

        var svg = d3.select("body").transition();
        danes = true;


		svg.select(".line1")   // change the line
        	.duration(750)
            .attr("d", valueline(data,true));
        svg.select(".line2")   // change the line
        	.duration(750)
            .attr("d", valueline2(data2));

        svg.select(".x.axis") // change the x axis
            .duration(750)
            .call(xAxis);
        svg.select(".yRight.axis") // change the y axis
            .duration(750)
            .call(yAxisRight);
        svg.select(".yLeft.axis") // change the y axis
            .duration(750)
            .call(yAxisLeft);

        myTextTitle.data(data)
		    .transition().duration(1000/2)
		    .style("opacity", 0)
		    .transition().duration(1000/2)
		    .style("opacity", 1)
		    .text('Danes and foreigners')

		ylabel1.transition().duration(1000/2)
		    .style("opacity", 0)
		    .transition().duration(1000/2)
		    .style("opacity", 1)
		    .text('Number of Danes')

		ylabel2.transition().duration(1000/2)
		    .style("opacity", 0)
		    .transition().duration(1000/2)
		    .style("opacity", 1)
		    .text('Number of foreigners')

	});
}

$( function() {

	$( "#slider-range-max" ).slider({
	range: "max",
	min: 1992,
	max: 2015,
	value: 2015,
	slide: function( event, ui ) {
	    $( "#amount" ).val( ui.value );

	    var datayear = ui.value
	    editBars(datayear)

	    myTextTitleBar.text("Top 25 nationalities in CPH in " + datayear.toString());
	}
	});
	$( "#amount" ).val( $( "#slider-range-max" ).slider( "value" ) );
} );


}

</script>
</body>