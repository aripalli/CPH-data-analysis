<!DOCTYPE html>
<meta charset="utf-8">
<style> /* set the CSS */

body { font: 12px Arial;}

path { 
    stroke: steelblue;
    stroke-width: 2;
    fill: none;
}

.axis path,
.axis line {
    fill: none;
    stroke: grey;
    stroke-width: 1;
    shape-rendering: crispEdges;
}
.Ari {
    position: right;
}

</style>
<body>

<div class="eitthvad"></div>

<div><select class="Country"></select></div>
<div><select class="District"></select></div>
<select id="Data">
		<option value="">Data without districts</option>
        <option value="1" selected="selected">Data with districts</option>
</select>

<select id="inds">
        <option value="Percentage" selected="selected">Percentage</option>
        <option value="Total">Total</option>
        <option value="Both">Both</option>
</select>

<!-- load the d3.js library -->    
<script src="http://d3js.org/d3.v3.min.js"></script>

<script>

// Set the dimensions of the canvas / graph
var margin = {top: 30, right: 20, bottom: 30, left: 50},
    width = 900- margin.left - margin.right,
    height = 350 - margin.top - margin.bottom;
    var padding = 30;

// Parse the date / time
var parseDate = d3.time.format("%d-%b-%y").parse;

// Set the ranges
var x = d3.scale.linear().range([padding, width - padding * 2]);
var y = d3.scale.linear().range([height - padding, 0]);
var y1 = d3.scale.linear().range([height - padding, 0]);
// Define the axes
var xAxis = d3.svg.axis().scale(x).orient("bottom").tickFormat(d3.format("y"));

var yAxisLeft = d3.svg.axis().scale(y)
    .orient("left").ticks(5);
var yAxisRight = d3.svg.axis().scale(y1)
    .orient("right").ticks(5); 



var secVar = "Total"

// Define the line
var valueline = d3.svg.line()
    .x(function(d,section) { return x(d.AAR); })
    .y(function(d,section) {
            if(secVar == "Percentage") {return y(d.Percentage)}
            else {return y(d.Total)}  
});

var valueline2 = d3.svg.line()
    .x(function(d) { return x(d.AAR); })
    .y(function(d) { 
        return y1(d.Percentage)});
    
// Adds the svg canvas
var svg = d3.select(".eitthvad")
    .append("svg")
        .attr("width", width + margin.left + margin.right+150)
        .attr("height", height + margin.top + margin.bottom)
    .append("g")
        .attr("transform", 
              "translate(" + margin.left + "," + margin.top + ")");

// Get the data
var dataset = "KBH_Stats_noDanes_noBydel_1.csv"
theCreation(dataset)

function DataSelection() {
    var sect = document.getElementById("Data");
    secVar = sect.options[sect.selectedIndex].value;
    var District = 0
    if (secVar == "1")
    {
        dataset = "KBH_Stats_noDanes.csv"
        District = 1
    }
    else
    {
        dataset = "KBH_Stats_noDanes_noBydel_1.csv"
    }
    theCreation(dataset,District)
}

function theCreation(dataset,District)
{
	d3.csv(dataset, function(error, data) {
	    data.forEach(function(d) {
	        d.AAR = +d.AAR;
	        d.STATKODE = +d.STATKODE;
	        d.Total = +d.Total;
	        d.Percentage = +d.Percentage;
	        if (District == 1)
	        {
	        	d.District =+ d.BYDEL
	        }
	    });


	    // When Country is change!
	    var select = d3.select('.Country')
	        .attr('class','select Country')
	        .on('change',onchange)



	    var options = select
	      .selectAll('option')
	        .data(d3.map(data, function(d){return d['COUNTRY'];}).keys().sort())
	        .enter()
	        .append('option')
	            .text(function (d) { return d});

	    // When District is Change!
	    if (District == 1)
	    {
	    	var select = d3.select('.District')
	        .attr('class','select District')
	        .on('change',onchange)
		    var options = select
		      .selectAll('option')
		        .data(d3.map(data, function(d)
		        {
		        	return d['DISTRICT']
		        }).keys().sort())
		        
		        .enter()
		        .append('option')
		            .text(function (d) { return d});
	    }
	    else
	    {
	    	var select = d3.select('.District')
	        .attr('class','select District')
		    var options = select
		      .selectAll('option')
		      	.remove()
		        .append('option')
		            .text(function (d) { return 'All Districts'});
	    }

	    // When The Option is change!
	    d3.select('#inds')
	        .on('change',onchange)

	    // Dataset is change!
	    d3.select('#Data')
	    	.on('change',DataSelection)

/*	    function onchange() {
	        selectValue = d3.select('.Country').property('value')
	        plot(data,selectValue)
	    }*/

	    function onchange() {
	        selectValueCountry = d3.select('.Country').property('value')
	        selectValueDistrict = d3.select('.District').property('value')
	        plot(data,selectValueCountry,selectValueDistrict)
	    }



	    function plot(data,selectValueCountry){
	        var sect = document.getElementById("inds");
	        secVar = sect.options[sect.selectedIndex].value;

	        // Filter the data
	        data = data.filter(function(row)
	        {
	        	if (District == 1)
	        	{
	        		return (row['COUNTRY'] == selectValueCountry && row['DISTRICT'] == selectValueDistrict);

	        	}
	        	else
	        	{
		            return row['COUNTRY'] == selectValueCountry;	
	        	}

	        });
	        // Clear data from plot

	        svg.selectAll('*').remove();
	        

	        // Scale the range of the data
	        x.domain(d3.extent(data, function(d) 
	       	{
	       		return d.AAR 
	       	}));

	        if (secVar == "Both")
	        {
	            y.domain([0, d3.max(data, function(d) 
	            { 
	                return Math.max(d.Total);
	            })]);

	            y1.domain([0, d3.max(data, function(d) 
	            { return Math.max(d.Percentage);
	            })]);
	                    // Add the valueline path.
	            svg.append("path")
	            .attr("d", valueline(data,secVar));


	            // Add the valueline path.
	            svg.append("path")
	            .attr("class", "line")
	            .style("stroke", "red")
	            .attr("d", valueline2(data));

	            // Add the X Axis
	            svg.append("g")
	            .attr("class", "x axis")
	            .attr("transform", "translate(0," + height + ")")
	            .call(xAxis);

	            // Add the Y Axis
	             svg.append("g")
	            .attr("class", "y axis")
	            .style("fill", "steelblue")
	            .call(yAxisLeft);

	            svg.append("g")             
	            .attr("class", "y axis")
	            .attr("transform", "translate(" + width + " ,0)")     
	            .style("fill", "red")       
	            .call(yAxisRight);

	            svg.append("text")
	            .attr("text-anchor", "middle")  // this makes it easy to centre the text as the transform is applied to the anchor
	            .attr("transform", "translate("+ (width/2-50) +","+(height+(padding))+")")  // centre below axis
	            .text("Year");

	            svg.append("text")
	            .attr("text-anchor", "middle")  // this makes it easy to centre the text as the transform is applied to the anchor
	            .attr("transform", "translate("+ (padding/2) +","+(height/2)+")rotate(-90)")  // text is drawn off the screen top left, move down and out and rotate
	            .text("Total");

	            svg.append("text")
	            .attr("text-anchor", "middle")  // this makes it easy to centre the text as the transform is applied to the anchor
	            .attr("transform", "translate("+  (width - (padding/2)) +","+(height/2) +")rotate(90)")  // text is drawn off the screen top left, move down and out and rotate
	            .text("Percentage");

	        }
	        else
	        {

	            y.domain([0, d3.max(data, function(d) 
	            { 
	                if(secVar == 'Percentage') {return d.Percentage}
	                else {return d.Total} 
	            })]);
	            
	            // Add the valueline path.
	            svg.append("path")
	            .attr("class", "line")
	            .attr("d", valueline(data,secVar));
	        	// Add the X Axis
	            svg.append("g")
	            .attr("class", "x axis")
	            .attr("transform", "translate(0," + height + ")")
	            .call(xAxis);

	            svg.append("text")
	            .attr("text-anchor", "middle")  // this makes it easy to centre the text as the transform is applied to the anchor
	            .attr("transform", "translate("+ (width/2-50) +","+(height+(padding))+")")  // centre below axis
	            .text("Year");

		        // Add the Y Axis
		        svg.append("g")
		            .attr("class", "y axis")
		            .call(yAxisLeft);
		        
		    	svg.append("text")
		        .attr("text-anchor", "middle")  // this makes it easy to centre the text as the transform is applied to the anchor
		        .attr("transform", "translate("+ (padding/2) +","+(height/2)+")rotate(-90)")  // text is drawn off the screen top left, move down and out and rotate
		        .text(secVar);

	        }

	    }



	});
}

</script>
</body>